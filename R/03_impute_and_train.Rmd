---
title: "03: Impute data and train model"
output: html_notebook
---

## Setup
```{r}
library(magrittr)
library(futile.logger)
library(caret)
library(mice)
library(foreach)
library(doParallel)

source("R/imputation_definitions.R")
```

```{r}
training_data <- read.csv("../contracted_training_data.csv", row.names=1, as.is = TRUE) 
outcome <- read.csv("../outcomes.csv", as.is = TRUE)

outcome <- factor(outcome[,2], levels = c("1", "0"), labels = c("positive", "negative"))
```

## Exploratory computations
```{r}
sum(training_data$Type.SNV)
sum(training_data$Type.INS)
sum(training_data$Type.DEL)
```

## Removal of problematic features

### Near-zero variance
```{r}
nearzerovariance <- caret::nearZeroVar(training_data, saveMetrics = TRUE)
print(nearzerovariance[nearzerovariance$nzv, ])

if (any(nearzerovariance$nzv)) {
  training_data <- training_data[, !nearzerovariance$nzv]
}
```

### Highly correlated features
```{r}
correlations <- cor(training_data, use = "pairwise.complete.obs")
correlations[is.na(correlations)] <- 0.0

highly_correlated_variables <- caret::findCorrelation(correlations, verbose = TRUE, names = TRUE)
print(highly_correlated_variables)

if(highly_correlated_variables %>% length > 0) {
  training_data <- training_data[, !colnames(training_data) %in% highly_correlated_variables]
}
```

## Imputation
```{r}
lapply(imputation_hyperparameter_grids, nrow)
```

```{r}
run_imputation_method <- function(data, method, hyperparams, times, iterations) {

  print(paste0("Starting with ", paste0(hyperparams, collapse = ", "), ", imputing ", times, " times"))

  imputation_object <- mice::mice(data = data, method = method,  m = times, maxit = iterations, ... = hyperparams)

  print("done with imputation")

  completed_datasets <- mice::complete(imputation_object, action = "all")

  print("done with forming datasets")

  return(list(completed_datasets = completed_datasets, imputation_object = imputation_object))
}

times <- 2
iters <- 5

imputation_result_per_imp_method <- list()
timings <- list()

for (method in names(imputation_hyperparameter_grids)) {

  hyperparams <- imputation_hyperparameter_grids[[method]]

  timings[[method]] <- list()
  imputation_result_per_imp_method[[method]] <- list()

  for (hp_set in 1:nrow(hyperparams)) {
    timings[[method]][[hp_set]] <- system.time(
      imputation_result_per_imp_method[[method]][[hp_set]] <- tryCatch(
        run_imputation_method(data = training_data, method = method, iterations = iters, hyperparams = unlist(hyperparams[hp_set,]), times = times), 
        error = function(e) {
          print(e)
          return(NULL)
        }
      )
    )
  }
  timings[[method]] = do.call(rbind, timings[[method]])
}
```

## Training
```{r}
hyperparameter_grid <- data.frame(mtry = 1:5 * 8 - 1)

training_settings <- trainControl(classProbs = TRUE,
                                  verboseIter = TRUE,
                                  method = "oob",
                                  returnResamp = "all")

models <- foreach(imputed_data_per_method = imputation_result_per_imp_method) %do% {

  models_per_imp_method <- foreach(imputed_dataset_per_hyperparameter = imputed_data_per_method) %do% {

    models_per_imp_rep <- foreach(imputed_dataset_per_imp_rep = imputed_dataset_per_hyperparameter$completed_datasets) %do% {

      train_args <- list(x = imputed_dataset_per_imp_rep,
                         y = outcome,
                         method = "rf",
                         preProcess = c("center", "scale"),
                         trControl = training_settings,
                         tuneGrid = hyperparameter_grid)

      rf_model <- do.call(caret::train, train_args)

      rf_model

    }
  }
}
```

```{r}
for (m in models) {
  print(plot(m))
}
```

```{r}
for (m in models) {
  plot(m$finalModel$err.rate[,"OOB"], type = "l")
}
```

```{r}
accs <- foreach(m = models, .combine='c') %do% m$results[row.names(m$bestTune), "Accuracy"]
mean(accs)
sd(accs)
```

## Saving model
```{r}
if (!dir.exists("../output")) {
  dir_creation_success <- dir.create("../output", showWarnings = TRUE)
  if (!dir_creation_success) {
    stop("Failed to create directory for saving model.")
  }
}

saveRDS(rf_model, file = "../output/rf_model.rds")
```
