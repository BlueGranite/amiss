---
title: "Prediction on test set"
output: html_notebook
---

```{r}
library(magrittr)
library(mice)
library(caret)

source("recursive_application.R")

test_data <- read.csv("../contracted_test_data.csv", row.names = 1, as.is = TRUE)
outcome <- read.csv("../test_outcomes.csv", as.is = TRUE)
final_features <- readRDS("../output/final_features.rds")
test_data <- test_data[, final_features]

# Recode outcomes as 1 -> "positive", 0 -> "negative"
outcome <- factor(outcome[,2], levels = c("1", "0"), labels = c("positive", "negative"))
head(outcome)
```

```{r}
rf_imputers <- readRDS("../output/rf_imputers_models.rds")
rf_hyperparams <- readRDS("../output/rf_hp_configs_models.rds")
lr_imputers <- readRDS("../output/lr_imputers_models.rds")
lr_hyperparams <- readRDS("../output/lr_hp_configs_models.rds")

times <- 5
iters <- 1

mice_w_hps <- function(method, hps) {
  
  imputation_object <- mice::mice(data = test_data,
                                  method = method,
                                  m = times,
                                  maxit = iters,
                                  printFlag = FALSE,
                                  ... = hps)
  
  completed_datasets <- mice::complete(data = imputation_object, "all")
  
  return(list(completed_datasets = completed_datasets, imputation_object = imputation_object))
}
bind_hps <- function(hps) {
  return(function(method) mice_w_hps(method, hps))
}

rf_imputation_functions <- lapply(rf_hyperparams, FUN = bind_hps)
rf_imputations <- lapply(names(rf_imputation_functions), function(method) recursive_apply(rf_imputation_functions[[method]], fun = function(x) x(method), "function"))
names(rf_imputations) <- names(rf_imputation_functions)

lr_imputation_functions <- lapply(lr_hyperparams, FUN = bind_hps)
lr_imputations <- lapply(names(lr_imputation_functions), function(method) recursive_apply(lr_imputation_functions[[method]], fun = function(x) x(method), "function"))
names(lr_imputations) <- names(lr_imputation_functions)
```

```{r}
median_imp <- function(col) {
  if (any(is.na(col))) {
    col[is.na(col)] <- median(col, na.rm = TRUE)
  }
  return(col)
}

rf_models <- readRDS("../output/rf_classifier_models.rds")
lr_models <- readRDS("../output/lr_classifier_models.rds")

prediction <- function(models, imputations) {
  predictions <- lapply(names(models), function(method) {
    pred_per_model <- lapply(models[[method]], function(model) {
      pred_per_completion <- lapply(imputations[[method]][["completed_datasets"]], function(completed_dataset) {
        cd <- data.frame(lapply(completed_dataset, median_imp))
        predict(model, cd, type = "prob")[,"positive", drop = TRUE]
      })
      names(pred_per_completion) <- paste0("imp_", 1:length(pred_per_completion))
      pred_per_completion
    })
    names(pred_per_model) <- paste0("model_", 1:length(pred_per_model))
    pred_per_model
  })
  names(predictions) <- names(models)
  return(predictions)
}
rf_predictions <- prediction(rf_models, rf_imputations)
lr_predictions <- prediction(lr_models, lr_imputations)

rf_confusion_matrices <- recursive_apply(rf_predictions, function(pred) {
  pred <- factor(c("positive", "negative")[2 - (pred > 0.5)], c("positive", "negative"))
  caret::confusionMatrix(pred, outcome)
}, x_class = "numeric")
lr_confusion_matrices <- recursive_apply(lr_predictions, function(pred) {
  pred <- factor(c("positive", "negative")[2 - (pred > 0.5)], c("positive", "negative"))
  caret::confusionMatrix(pred, outcome)
}, x_class = "numeric")

rf_mccs <- recursive_apply(rf_predictions, function(pred) ModelMetrics::mcc(as.integer(outcome == "positive"), pred, 0.5), x_class = "numeric")
rf_aucs <- recursive_apply(rf_predictions, function(pred) ModelMetrics::auc(as.integer(outcome == "positive"), pred), x_class = "numeric")

rf_mean_mccs <- leaf_apply(rf_mccs, . %>% unlist %>% mean, FALSE)
rf_mean_aucs <- leaf_apply(rf_aucs, . %>% unlist %>% mean, FALSE)

rf_sd_mccs <- leaf_apply(rf_mccs, . %>% unlist %>% sd, FALSE)
rf_sd_aucs <- leaf_apply(rf_aucs, . %>% unlist %>% sd, FALSE)

rf_mean_mean_mccs <- leaf_apply(rf_mean_mccs, . %>% unlist %>% mean, FALSE)
rf_mean_mean_aucs <- leaf_apply(rf_mean_aucs, . %>% unlist %>% mean, FALSE)

rf_sd_mean_mccs <- leaf_apply(rf_mean_mccs, . %>% unlist %>% sd, FALSE)
rf_sd_mean_aucs <- leaf_apply(rf_mean_aucs, . %>% unlist %>% sd, FALSE)

lr_mccs <- recursive_apply(lr_predictions, function(pred) ModelMetrics::mcc(as.integer(outcome == "positive"), pred, 0.5), x_class = "numeric")
lr_aucs <- recursive_apply(lr_predictions, function(pred) ModelMetrics::auc(as.integer(outcome == "positive"), pred), x_class = "numeric")

lr_mean_mccs <- leaf_apply(lr_mccs, . %>% unlist %>% mean, FALSE)
lr_mean_aucs <- leaf_apply(lr_aucs, . %>% unlist %>% mean, FALSE)

lr_sd_mccs <- leaf_apply(lr_mccs, . %>% unlist %>% sd, FALSE)
lr_sd_aucs <- leaf_apply(lr_aucs, . %>% unlist %>% sd, FALSE)

lr_mean_mean_mccs <- leaf_apply(lr_mean_mccs, . %>% unlist %>% mean, FALSE)
lr_mean_mean_aucs <- leaf_apply(lr_mean_aucs, . %>% unlist %>% mean, FALSE)

lr_sd_mean_mccs <- leaf_apply(lr_mean_mccs, . %>% unlist %>% sd, FALSE)
lr_sd_mean_aucs <- leaf_apply(lr_mean_aucs, . %>% unlist %>% sd, FALSE)
```